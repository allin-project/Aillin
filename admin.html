<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스포츠타운 관리자 페이지</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 이전과 동일한 스타일 */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #1e293b; margin: 0; display: flex; min-height: 100vh; }
        button { cursor: pointer; font-family: 'Noto Sans KR', sans-serif; }
        input, select, textarea { font-family: 'Noto Sans KR', sans-serif; }
        .card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); margin-bottom: 1.5rem; }
        .admin-sidebar { width: 240px; background-color: #334155; color: white; padding: 1.5rem 0; display: flex; flex-direction: column; flex-shrink: 0; }
        .admin-sidebar-header { padding: 0 1.5rem; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; }
        .admin-sidebar-header a { color: inherit; text-decoration: none; }
        .admin-nav-link { display: block; padding: 0.75rem 1.5rem; color: #cbd5e1; text-decoration: none; font-weight: 500; border-left: 4px solid transparent; }
        .admin-nav-link:hover { background-color: #475569; color: white; }
        .admin-nav-link.active { background-color: #1e293b; color: white; font-weight: 700; border-left-color: #10b981; }
        .admin-sidebar-footer { margin-top: auto; padding: 1.5rem; font-size: 0.875rem; color: #94a3b8; }
        .admin-sidebar-footer a { color: #cbd5e1; text-decoration: none; }
        .admin-sidebar-footer a:hover { text-decoration: underline; }
        .admin-main { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        .admin-main h1 { font-size: 2.25rem; font-weight: 700; margin-top: 0; margin-bottom: 2rem; }
        .view { display: none; }
        .view.active { display: block; }
        .table-container { background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); overflow-x: auto; }
        .data-table { width: 100%; font-size: 0.875rem; text-align: left; color: #64748b; border-collapse: collapse; }
        .data-table thead { font-size: 0.75rem; color: #334155; text-transform: uppercase; background-color: #f8fafc; }
        .data-table th, .data-table td { padding: 0.75rem 1.5rem; }
        .data-table tbody tr { border-bottom: 1px solid #f1f5f9; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: none; }
        .btn-primary { background-color: #059669; color: white; }
        .btn-primary:hover { background-color: #047857; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        td .btn { margin-right: 0.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem;}
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; box-sizing: border-box; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .stat-card { text-align: center; }
        .stat-card .stat-title { font-size: 1rem; color: #64748b; margin-bottom: 0.5rem; }
        .stat-card .stat-value { font-size: 2.5rem; font-weight: 700; color: #059669; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .photo-manage-card { position: relative; }
        .photo-manage-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; display: block; }
        .photo-manage-card .caption { font-size: 0.875rem; padding: 0.5rem 0; }
        .photo-manage-card .actions { margin-top: 0.5rem; }
    </style>
</head>
<body>

    <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
            <a href="#">스포츠타운</a>
        </div>
        <nav id="admin-nav">
            <a href="#" class="admin-nav-link active" data-view="dashboard-view">대시보드</a>
            <a href="#" class="admin-nav-link" data-view="match-view">경기 관리</a>
            <a href="#" class="admin-nav-link" data-view="post-view">게시물 관리</a>
            <a href="#" class="admin-nav-link" data-view="banner-view">배너 관리</a>
        </nav>
        <div class="admin-sidebar-footer">
            <a href="index.html">메인 사이트로 가기</a>
            <p>© 2025 Sportstown Admin</p>
        </div>
    </aside>

    <main class="admin-main">
        <div id="admin-view" class="view">
    </div>
        
        <div id="dashboard-view" class="view active">
            <h1>대시보드</h1>
            <div class="dashboard-grid">
                <div class="card stat-card">
                    <div class="stat-title">총 게시물</div>
                    <div class="stat-value" id="total-posts-stat">0</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-title">등록된 경기</div>
                    <div class="stat-value" id="total-matches-stat">0</div>
                </div>
                 <div class="card stat-card">
                    <div class="stat-title">전체 회원 수</div>
                    <div class="stat-value" id="total-users-stat">0</div>
                </div>
            </div>
            <div class="card" style="margin-top: 2rem;">
                <h2>최근 등록된 게시물</h2>
                <div class="table-container">
                    <table class="data-table">
                        <tbody id="recent-posts-table">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="match-view" class="view">
            <h1>경기 관리</h1>
            <div class="card">
                <h2>새 경기 추가 / 수정</h2>
                <form id="match-form">
                    <input type="hidden" id="match-id"> <div class="form-grid">
                        <div class="form-group">
                            <label for="match-sport">종목</label>
                            <select id="match-sport" required>
                                <option value="soccer">축구</option>
                                <option value="baseball">야구</option>
                                <option value="basketball">농구</option>
                                <option value="esports">e스포츠</option>
                            </select>
                        </div>
                        <div class="form-group"> <label for="match-team-a">홈팀</label> <input type="text" id="match-team-a" required> </div>
                        <div class="form-group"> <label for="match-team-b">원정팀</label> <input type="text" id="match-team-b" required> </div>
                        <div class="form-group"> <label for="match-score-a">홈팀 점수</label> <input type="number" id="match-score-a" value="0"> </div>
                        <div class="form-group"> <label for="match-score-b">원정팀 점수</label> <input type="number" id="match-score-b" value="0"> </div>
                        <div class="form-group"> <label for="match-time">진행 상태</label> <input type="text" id="match-time" placeholder="예: 8회초, 종료, 22:00" required> </div>
                    </div>
                    <div style="text-align: right; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" id="match-form-clear">초기화</button>
                        <button type="submit" class="btn btn-primary">저장하기</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>경기 목록</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>종목</th><th>홈팀</th><th>점수</th><th>원정팀</th><th>상태</th><th>관리</th></tr></thead>
                        <tbody id="matches-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="post-view" class="view">
            <h1>게시물 관리</h1>
            <div class="card">
                <div class="form-group" style="max-width: 300px;">
                    <label for="board-select">게시판 선택</label>
                    <select id="board-select">
                        <option value="freeboard">자유게시판</option>
                        <option value="announcements">공지사항</option>
                        <option value="soccer">축구 갤러리</option>
                        <option value="baseball">야구 갤러리</option>
                        <option value="basketball">농구 갤러리</option>
                        <option value="esports">e스포츠 갤러리</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr><th>ID</th><th>제목</th><th>글쓴이</th><th>작성일</th><th>관리</th></tr></thead>
                        <tbody id="posts-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
<h1>배너 관리</h1>
<div class="card">
    <h2>메인 페이지 배너 수정 (최대 5개)</h2>
    <p style="margin-top:-0.5rem; margin-bottom:1.5rem; color:#64748b;">내용을 비워두는 항목은 배너에 표시되지 않습니다.</p>
    <form id="banner-form">
        <h4>#1</h4>
        <div class="form-grid">
            <div class="form-group"><label for="banner-title-1">배너 제목 1</label><input type="text" id="banner-title-1"></div>
            <div class="form-group"><label for="banner-desc-1">배너 설명 1</label><input type="text" id="banner-desc-1"></div>
        </div>
        <hr style="border-color:#f1f5f9; margin: 1rem 0;">
        <h4>#2</h4>
        <div class="form-grid">
            <div class="form-group"><label for="banner-title-2">배너 제목 2</label><input type="text" id="banner-title-2"></div>
            <div class="form-group"><label for="banner-desc-2">배너 설명 2</label><input type="text" id="banner-desc-2"></div>
        </div>
        <hr style="border-color:#f1f5f9; margin: 1rem 0;">
        <h4>#3</h4>
        <div class="form-grid">
            <div class="form-group"><label for="banner-title-3">배너 제목 3</label><input type="text" id="banner-title-3"></div>
            <div class="form-group"><label for="banner-desc-3">배너 설명 3</label><input type="text" id="banner-desc-3"></div>
        </div>
        <hr style="border-color:#f1f5f9; margin: 1rem 0;">
        <h4>#4</h4>
        <div class="form-grid">
            <div class="form-group"><label for="banner-title-4">배너 제목 4</label><input type="text" id="banner-title-4"></div>
            <div class="form-group"><label for="banner-desc-4">배너 설명 4</label><input type="text" id="banner-desc-4"></div>
        </div>
        <hr style="border-color:#f1f5f9; margin: 1rem 0;">
        <h4>#5</h4>
        <div class="form-grid">
            <div class="form-group"><label for="banner-title-5">배너 제목 5</label><input type="text" id="banner-title-5"></div>
            <div class="form-group"><label for="banner-desc-5">배너 설명 5</label><input type="text" id="banner-desc-5"></div>
        </div>

        <div style="text-align: right; margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary">전체 배너 저장하기</button>
        </div>
    </form>
</div>

    </main>

<script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, collection, getDocs, getDoc, doc, addDoc, setDoc, deleteDoc, 
        query, where, orderBy, limit, serverTimestamp, increment 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAUuUlYHUwOuwnm_hsIsd7XHlj5voCecQk",
      authDomain: "community-d18d4.firebaseapp.com",
      projectId: "community-d18d4",
      storageBucket: "community-d18d4.firebasestorage.app",
      messagingSenderId: "497702481194",
      appId: "1:497702481194:web:a826db91628adc24718253",
      measurementId: "G-1SDLG2MEDN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 컬렉션 참조
    const matchesCol = collection(db, 'matches');
    const postsCol = collection(db, 'posts');
    const siteStatsDoc = doc(db, 'siteStats', 'summary');

    // --- 유틸리티 함수 ---
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        return new Date(timestamp.seconds * 1000).toLocaleDateString('ko-KR');
    };

    // --- 대시보드 로직 (변경 없음) ---
// admin.html의 <script> 태그 내부

async function loadDashboard() {
    try {
        // 기존 siteStats 문서 로직 (게시물, 경기 수)
        const statsSnap = await getDoc(siteStatsDoc);
        if (statsSnap.exists()) {
            const stats = statsSnap.data();
            document.getElementById('total-posts-stat').innerText = stats.totalPosts || 0;
            document.getElementById('total-matches-stat').innerText = stats.totalMatches || 0;
            // document.getElementById('total-users-stat').innerText = stats.totalUsers || 0; // 이 줄은 삭제하거나 주석 처리
        }

        // ✅ users 컬렉션 직접 카운트 로직 추가
        const usersCol = collection(db, 'users');
        const usersSnapshot = await getDocs(usersCol);
        document.getElementById('total-users-stat').innerText = usersSnapshot.size;

        // 최근 등록된 게시물 로직 (기존과 동일)
        const recentPostsQuery = query(postsCol, orderBy('createdAt', 'desc'), limit(5));
        const querySnapshot = await getDocs(recentPostsQuery);
        const tableBody = document.getElementById('recent-posts-table');
        tableBody.innerHTML = '';
        querySnapshot.forEach(doc => {
            const post = doc.data();
            tableBody.innerHTML += `<tr><td>[${post.board}] ${post.title}</td><td>${post.authorName}</td><td>${formatDate(post.createdAt)}</td></tr>`;
        });
    } catch (error) {
        console.error("대시보드 로딩 오류:", error);
        alert("대시보드 정보를 가져오는 데 실패했습니다.");
    }
}

    // ==========================================================
    // === 경기 관리 로직: START (이 부분이 수정되었습니다) ===
    // ==========================================================
    const matchForm = document.getElementById('match-form');
    const matchesTableBody = document.getElementById('matches-table-body');

    // 경기 목록을 불러와 한 줄씩 그리는 함수
    async function loadMatches() {
        const querySnapshot = await getDocs(query(matchesCol, orderBy('time')));
        matchesTableBody.innerHTML = ''; // 테이블 비우기
        querySnapshot.forEach(doc => {
            const match = doc.data();
            // 각 줄의 데이터를 data-* 속성으로 저장하여 재사용
            const row = document.createElement('tr');
            row.dataset.id = doc.id;
            row.dataset.match = JSON.stringify(match); // 데이터를 문자열로 저장
            row.innerHTML = renderMatchRow(match); // 일반 보기 모드로 렌더링
            matchesTableBody.appendChild(row);
        });
    }
    
    // 한 줄의 일반 보기 모드 HTML을 생성하는 함수
    function renderMatchRow(match) {
        return `
            <td>${match.sport}</td>
            <td>${match.teamA}</td>
            <td>${match.scoreA} : ${match.scoreB}</td>
            <td>${match.teamB}</td>
            <td>${match.time}</td>
            <td>
                <button class="btn btn-secondary btn-edit-match">수정</button>
                <button class="btn btn-danger btn-delete-match">삭제</button>
            </td>
        `;
    }

    // 한 줄의 수정 모드 HTML을 생성하는 함수
    function renderEditRow(match) {
        const sports = ['soccer', 'baseball', 'basketball', 'esports'];
        const options = sports.map(sport => `<option value="${sport}" ${match.sport === sport ? 'selected' : ''}>${sport}</option>`).join('');

        return `
            <td><select class="form-control">${options}</select></td>
            <td><input type="text" class="form-control" value="${match.teamA}"></td>
            <td>
                <input type="number" class="form-control score-a" value="${match.scoreA}" style="width: 45px;"> : 
                <input type="number" class="form-control score-b" value="${match.scoreB}" style="width: 45px;">
            </td>
            <td><input type="text" class="form-control" value="${match.teamB}"></td>
            <td><input type="text" class="form-control" value="${match.time}"></td>
            <td>
                <button class="btn btn-primary btn-save-match">저장</button>
                <button class="btn btn-secondary btn-cancel-edit">취소</button>
            </td>
        `;
    }

    // 경기 추가 (상단 폼 사용)
    matchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const matchData = {
            sport: document.getElementById('match-sport').value,
            teamA: document.getElementById('match-team-a').value,
            teamB: document.getElementById('match-team-b').value,
            scoreA: Number(document.getElementById('match-score-a').value),
            scoreB: Number(document.getElementById('match-score-b').value),
            time: document.getElementById('match-time').value,
        };

        try {
            await addDoc(matchesCol, matchData);
            await setDoc(siteStatsDoc, { totalMatches: increment(1) }, { merge: true });
            alert("경기가 추가되었습니다.");
            matchForm.reset();
            await loadMatches(); // 목록 새로고침
            await loadDashboard();
        } catch (error) {
            console.error("경기 추가 오류:", error);
            alert("경기 정보 추가에 실패했습니다.");
        }
    });
    
    // 폼 초기화 버튼
    document.getElementById('match-form-clear').addEventListener('click', () => {
         matchForm.reset();
    });

    // 경기 수정/저장/취소/삭제 버튼 이벤트 위임
    matchesTableBody.addEventListener('click', async (e) => {
        const target = e.target;
        const tr = target.closest('tr');
        if (!tr) return;
        const docId = tr.dataset.id;
        const originalMatchData = JSON.parse(tr.dataset.match);

        // 수정 버튼 클릭: 해당 줄을 '수정 모드'로 변경
        if (target.classList.contains('btn-edit-match')) {
            tr.innerHTML = renderEditRow(originalMatchData);
        }

        // 취소 버튼 클릭: 원래의 '일반 보기 모드'로 복원
        if (target.classList.contains('btn-cancel-edit')) {
            tr.innerHTML = renderMatchRow(originalMatchData);
        }

        // 저장 버튼 클릭: 변경된 내용을 Firestore에 업데이트
        if (target.classList.contains('btn-save-match')) {
            const inputs = tr.querySelectorAll('td');
            const updatedData = {
                sport: inputs[0].querySelector('select').value,
                teamA: inputs[1].querySelector('input').value,
                scoreA: Number(inputs[2].querySelector('.score-a').value),
                scoreB: Number(inputs[2].querySelector('.score-b').value),
                teamB: inputs[3].querySelector('input').value,
                time: inputs[4].querySelector('input').value,
            };
            try {
                await setDoc(doc(db, 'matches', docId), updatedData);
                alert("경기가 수정되었습니다.");
                // 업데이트 성공 후, 다시 '일반 보기 모드'로 변경
                tr.dataset.match = JSON.stringify(updatedData); // 업데이트된 데이터로 속성 갱신
                tr.innerHTML = renderMatchRow(updatedData);
            } catch (error) {
                console.error("경기 수정 오류:", error);
                alert("경기 수정에 실패했습니다.");
            }
        }

        // 삭제 버튼 클릭
        if (target.classList.contains('btn-delete-match')) {
            if (confirm("정말로 이 경기를 삭제하시겠습니까?")) {
                try {
                    await deleteDoc(doc(db, 'matches', docId));
                    await setDoc(siteStatsDoc, { totalMatches: increment(-1) }, { merge: true });
                    alert("경기가 삭제되었습니다.");
                    tr.remove(); // 화면에서 해당 줄 즉시 제거
                    await loadDashboard();
                } catch (error) {
                    console.error("경기 삭제 오류:", error);
                    alert("경기 삭제에 실패했습니다.");
                }
            }
        }
    });
    // ========================================================
    // === 경기 관리 로직: END (여기까지 수정되었습니다) ===
    // ========================================================


    // --- 게시물 관리 로직 (변경 없음) ---
    const boardSelect = document.getElementById('board-select');
    const postsTableBody = document.getElementById('posts-table-body');

    async function loadPosts(boardId) {
        const q = query(postsCol, where("board", "==", boardId), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        postsTableBody.innerHTML = '';
        querySnapshot.forEach(doc => {
            const post = doc.data();
postsTableBody.innerHTML += `
    <tr data-id="${doc.id}">
        <td>${doc.id}</td>
        <td>${post.title}</td>
        <td>${post.authorName}</td>
        <td>${formatDate(post.createdAt)}</td>
        <td><button class="btn btn-danger btn-delete-post">삭제</button></td>
    </tr>`;
        });
    }

    boardSelect.addEventListener('change', () => {
        loadPosts(boardSelect.value);
    });

    postsTableBody.addEventListener('click', async (e) => {
         if (e.target.classList.contains('btn-delete-post')) {
            const docId = e.target.closest('tr').dataset.id;
            if (confirm("정말로 이 게시물을 삭제하시겠습니까?")) {
                try {
                    await deleteDoc(doc(db, 'posts', docId));
                    await setDoc(siteStatsDoc, { totalPosts: increment(-1) }, { merge: true });
                    alert("게시물이 삭제되었습니다.");
                    await loadPosts(boardSelect.value);
                    await loadDashboard();
                } catch (error) {
                    console.error("게시물 삭제 오류:", error);
                    alert("게시물 삭제에 실패했습니다.");
                }
            }
        }
    });




  // ==========================================================
// === 배너 관리 로직: START (이 전체를 교체해주세요) ===
// ==========================================================
const bannerForm = document.getElementById('banner-form');

// 배너 관리 탭이 로드될 때 현재 데이터를 불러오는 함수
async function loadBannerManagement() {
    try {
        const bannerRef = doc(db, "site_config", "main_banner");
        const bannerSnap = await getDoc(bannerRef);
        if (bannerSnap.exists() && bannerSnap.data().items) {
            const items = bannerSnap.data().items;
            for (let i = 0; i < 5; i++) {
                const titleInput = document.getElementById(`banner-title-${i + 1}`);
                const descInput = document.getElementById(`banner-desc-${i + 1}`);
                if (items[i]) {
                    titleInput.value = items[i].title || '';
                    descInput.value = items[i].description || '';
                } else {
                    titleInput.value = '';
                    descInput.value = '';
                }
            }
        }
    } catch (error) {
        console.error("배너 정보 로딩 오류:", error);
        alert("기존 배너 정보를 불러오는 데 실패했습니다.");
    }
}

// 배너 저장 폼 제출 이벤트 처리
bannerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const bannerItems = [];
    for (let i = 1; i <= 5; i++) {
        const title = document.getElementById(`banner-title-${i}`).value.trim();
        const description = document.getElementById(`banner-desc-${i}`).value.trim();
        
        // 제목과 설명이 둘 다 입력된 경우에만 배열에 추가
        if (title && description) {
            bannerItems.push({ title, description });
        }
    }

    try {
        const bannerRef = doc(db, "site_config", "main_banner");
        // items 라는 필드에 배열 전체를 저장
        await setDoc(bannerRef, { items: bannerItems });
        alert('배너가 성공적으로 업데이트되었습니다.');
    } catch (error) {
        console.error("배너 업데이트 오류:", error);
        alert('배너 업데이트에 실패했습니다.');
    }
});
// ========================================================
// === 배너 관리 로직: END (여기까지 교체) ===
// ========================================================


    // --- 네비게이션 및 초기화 로직 (변경 없음) ---
    const nav = document.getElementById('admin-nav');
    const views = document.querySelectorAll('.view');
    
    nav.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
            e.preventDefault();
            if (nav.querySelector('.active')) {
                nav.querySelector('.active').classList.remove('active');
            }
            e.target.classList.add('active');
            
            const viewId = e.target.dataset.view;
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }
    });
    
    // 페이지 로드 시 실행될 초기화 함수
    async function init() {
        await loadDashboard();
        await loadMatches();
        await loadPosts(boardSelect.value); // 초기 선택된 게시판 로드
        await loadBannerManagement();
    }

    init(); // 초기화 함수 실행
</script>
    </body>
</html>