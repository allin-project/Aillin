<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìŠ¤í¬ì¸  ì»¤ë®¤ë‹ˆí‹° í”„ë¡œí† íƒ€ì…</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="icon" href="logo.png" type="image/png" />
    <style>
/* === New Theme based on Image === */
:root {
  --primary-color: #5f4b8b;
  --primary-dark:  #4a3a70;
  --primary-light: #f4f2f9;

  --text-color: #333;
  --text-light: #666;
  --border-color: #e9ebee;
  --background-body: #f0f2f5;
  --background-widget-header: #f8f9fa;
  --background-white: #ffffff;
  --danger-color: #d9534f;

  --font-body: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
  --border-radius: 4px;
}

* { box-sizing: border-box; }

body {
  font-family: var(--font-body);
  background-color: var(--background-body);
  color: var(--text-color);
  font-size: 14px;
  display: flex; flex-direction: column; min-height: 100vh; margin: 0;
}
.container { width: 100%; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 1rem; flex-grow: 1; }
.view { display: none; }
.view.active { display: block; }

/* === Header & Nav === */
.header {
  display: flex; flex-direction: row; justify-content: space-between; align-items: center;
  background-color: var(--background-white);
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 1.5rem;
  border-radius: var(--border-radius);
}
.header h1 {
  font-size: 1.8rem; font-weight: 700; color: var(--primary-color); cursor: pointer; margin: 0;
}
.header .main-nav-container {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.main-nav ul { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; font-weight: 700; list-style: none; padding: 0; margin: 0; }
.nav-link { padding: 0.5rem 1rem; display: block; color: var(--text-color); text-decoration: none; cursor: pointer; border-radius: var(--border-radius); }
.nav-link:hover { background-color: var(--primary-light); color: var(--primary-dark); }
.nav-link.active { color: var(--primary-dark); font-weight: 700; }
.sports-gallery-menu { position: relative; }
.sports-gallery-dropdown {
  position: absolute; display: none; margin-top: 5px; width: 10rem; background-color: var(--background-white);
  border-radius: var(--border-radius); box-shadow: 0 5px 10px rgba(0,0,0,.1); z-index: 10; border: 1px solid var(--border-color);
  padding: 5px;
}
.sports-gallery-dropdown.show { display: block; }
.sports-gallery-dropdown .nav-link { width: 100%; }
.mobile-user-menu { display: none; } /* Hide mobile menu on desktop */

/* === Main Page Grid & Widgets (New) === */
.main-grid {
    display: grid;
    grid-template-columns: minmax(0, 2.5fr) minmax(0, 1fr);
    gap: 1.5rem;
    align-items: flex-start;
}

.main-banner {
    position: relative;
    overflow: hidden; /* ìŠ¬ë¼ì´ë“œë¥¼ ìœ„í•´ ë„˜ì¹˜ëŠ” ë¶€ë¶„ì€ ìˆ¨ê¹€ */
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    padding: 0; /* âœ… ë¬¸ì œì˜ ì›ì¸ì´ì—ˆë˜ íŒ¨ë”©ì„ 0ìœ¼ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤. */
    background-color: var(--primary-dark); /* ì´ë¯¸ì§€ê°€ ë¡œë”©ë˜ê¸° ì „ì˜ ë°°ê²½ìƒ‰ */
}
.main-banner h2 { font-size: 1.6rem; margin: 0 0 0.5rem 0; font-weight: 700; }
.main-banner p { margin: 0; font-size: 1rem; opacity: 0.9; }

.banner-slide {
    flex: 0 0 100%;
    box-sizing: border-box;
    min-height: 250px; /* ë°°ë„ˆì˜ ìµœì†Œ ë†’ì´ ì§€ì • */
    border-radius: var(--border-radius);
    padding: 2.5rem 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    
    /* ë°°ê²½ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
}

/* ì´ë¯¸ì§€ ìœ„ì— ì–´ë‘ìš´ ì˜¤ë²„ë ˆì´ ì¶”ê°€ */
.banner-slide::before {
    content: '';
    position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
    background-color: rgba(0, 0, 0, 0.4); /* 40% íˆ¬ëª…ë„ì˜ ê²€ì€ìƒ‰ ì˜¤ë²„ë ˆì´ */
    border-radius: var(--border-radius);
    z-index: 1;
}

/* í…ìŠ¤íŠ¸ê°€ ì˜¤ë²„ë ˆì´ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
.banner-text-overlay {
    position: relative;
    z-index: 2;
    color: white;
}

.main-left { display: flex; flex-direction: column; gap: 1.5rem; }
.main-right { display: flex; flex-direction: column; gap: 1.5rem; }

.widget {
    background-color: var(--background-white);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: 0 1px 3px rgba(0,0,0,.03);
}
.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--background-widget-header);
}
.widget-header h2 { font-size: 1.1rem; margin: 0; font-weight: 700; color: var(--primary-dark); }
.widget-header .view-more { font-size: 0.9em; font-weight: 500; color: var(--text-light); text-decoration: none; }
.widget-body { padding: 15px; }
.widget-body ul, .widget-body li { margin: 0; padding: 0; list-style: none; }

.widget-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

/* New Preview List Style */
.preview-list-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 7px 2px;
    border-bottom: 1px dotted #ccc;
}
.preview-list-item:last-child { border-bottom: none; }
.preview-title {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-decoration: none;
    color: var(--text-color);
}
.preview-title:hover { text-decoration: underline; }
.comment-count { color: var(--danger-color); font-weight: 700; font-size: 0.9em; flex-shrink: 0; }
.preview-date { font-size: 0.9em; color: var(--text-light); flex-shrink: 0; }

/* Sidebar Login Widget */
.sidebar-input {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 0.5rem;
}
.sidebar-auth-links {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 1rem;
    font-size: 0.9em;
}
.sidebar-auth-links a { color: var(--text-light); text-decoration: none; }
.sidebar-auth-links a:hover { text-decoration: underline; }

/* === Board/Post Views (Inherits new theme) === */
.board-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem; }
.table-container { border-top: 2px solid var(--primary-dark); background: var(--background-white); border: 1px solid var(--border-color); }
.post-table { width: 100%; border-collapse: collapse; text-align: center; }
.post-table thead tr { background-color: var(--background-widget-header); }
.post-table th, .post-table td { padding: 10px 5px; border-bottom: 1px solid var(--border-color); }
.post-table tbody tr:hover { background-color: var(--primary-light); cursor: pointer; }
.pagination { display: flex; justify-content: center; margin-top: 1rem; }
.pagination button { padding: 4px 8px; margin: 0 2px; border: 1px solid var(--border-color); background-color: var(--background-white); color: var(--text-light); cursor: pointer; }
.pagination button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-dark); font-weight: 700; }
.write-btn {
  background-color: #f0f0f0; color: var(--text-color); padding: 6px 14px;
  border-radius: var(--border-radius); font-weight: 500; border: 1px solid #ccc; cursor: pointer;
}
.write-btn:hover { background-color: #e0e0e0; }
.write-btn.primary { background-color: var(--primary-color); border-color: var(--primary-dark); color: #fff; }
.write-btn.primary:hover { background-color: var(--primary-dark); }

#post-content-view { border: 1px solid var(--border-color); background-color: var(--background-white); }
.post-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); background-color: var(--background-widget-header); }
#comments-section { margin-top: 1rem; border: 1px solid var(--border-color); background-color: var(--background-white); }
.comment-form { background-color: var(--background-widget-header); }

/* === Modal === */
.modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 50;}
.modal-overlay.show { display: flex; }
.modal-box { padding: 1.5rem; border-radius:var(--border-radius); width: 100%; max-width: 420px; background-color: var(--background-white); border: 1px solid #333;}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.modal-header h2 { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); }
.modal-body .form-group { margin-bottom: 1rem; }
.modal-body label { display: block; margin-bottom: .5rem; font-weight: 500; }
.modal-body input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--border-radius); }

/* Footer */
footer {
  background-color: #e2e2e2; color: #555; margin-top: auto;
  padding: 1.5rem 0; text-align:center; border-top: 1px solid #dcdcdc;
}

/* === Mobile Optimization === */
@media (max-width: 992px) {
    .main-grid {
        grid-template-columns: 1fr;
    }
    .main-right {
        display: none; /* Hide sidebar on mobile */
    }
    .header {
        flex-wrap: wrap;
        justify-content: space-between;
    }
    .main-nav-container {
        order: 3;
        width: 100%;
        margin-top: 1rem;
    }
    .mobile-user-menu {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }
    .mobile-user-menu a, .mobile-user-menu button {
        color: var(--text-light);
        text-decoration: none;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.9em;
        font-family: inherit;
        font-weight: 500;
        padding: 0.25rem;
    }
    .mobile-user-menu span {
        font-weight: 700;
        font-size: 0.9em;
    }
}

.main-left .prediction-widget-container {
    display: none;
}


/* ë°°ë„ˆ ì¶”ê°€í–ˆì–ì•„  */
/* index.html íŒŒì¼ì˜ <style> íƒœê·¸ ì•ˆ ì ì ˆí•œ ìœ„ì¹˜ì— ì¶”ê°€ */

.main-banner {
    position: relative;
    overflow: hidden; /* ìŠ¬ë¼ì´ë“œë¥¼ ìœ„í•´ ë„˜ì¹˜ëŠ” ë¶€ë¶„ì€ ìˆ¨ê¹€ */
}

.banner-slides-container {
    display: flex;
    transition: transform 0.5s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ ìŠ¬ë¼ì´ë“œ íš¨ê³¼ */
}

.banner-slide {
    flex: 0 0 100%; /* ê° ìŠ¬ë¼ì´ë“œëŠ” ë°°ë„ˆ ë„ˆë¹„ì˜ 100%ë¥¼ ì°¨ì§€ */
    box-sizing: border-box;
    text-align: center;
}

.banner-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(0, 0, 0, 0.3);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 24px;
    cursor: pointer;
    z-index: 10;
}
.banner-nav-btn:hover {
    background-color: rgba(0, 0, 0, 0.6);
}

#prev-banner-btn { left: 15px; }
#next-banner-btn { right: 15px; }

/* 992px ì´í•˜ ëª¨ë°”ì¼/íƒœë¸”ë¦¿ í™”ë©´ì¼ ë•Œ */
@media (max-width: 992px) {
    /* ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”ëŠ” ì´ë¯¸ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë¯€ë¡œ,
       ì™¼ìª½(ëª¨ë°”ì¼ìš©) AI ì˜ˆì¸¡ ìœ„ì ¯ì„ ë‹¤ì‹œ ë³´ì—¬ì¤ë‹ˆë‹¤. */
    .main-left .prediction-widget-container {
        display: block;
    }
}

@media (max-width: 768px) {
    .widget-grid {
        grid-template-columns: 1fr;
    }
    .container {
        padding: 0.5rem;
    }
    .main-banner h2 {
        font-size: 1.3rem;
    }

    /* Responsive Table to Card List */
    .table-container {
        border-top: none;
    }
    .post-table thead {
        display: none;
    }
    .post-table tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 0.5rem;
    }
    .post-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: right;
        padding: 0.5rem;
        border-bottom: 1px dotted var(--border-color);
    }
    .post-table td:last-child {
        border-bottom: none;
    }
    .post-table td::before {
        content: attr(data-label);
        font-weight: bold;
        text-align: left;
        margin-right: 1rem;
    }
    .post-table td[data-label="ì œëª©"] {
        display: block;
        text-align: left;
        font-size: 1.1em;
        font-weight: 500;
        padding: 0.75rem 0.5rem;
    }
    .post-table td[data-label="ì œëª©"]::before {
        display: none;
    }
    .post-table td[data-label="ë²ˆí˜¸"] {
        display: none; /* Hide post number on mobile to save space */
    }
}




/* ì“¸ëª¨ì—†ìŒ */
/* ë¡œê³  ì˜† ë°°íŒ…í•˜ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.betting-btn {
    display: inline-block;
    background-color: #d9534f; /* ëˆˆì— ë„ëŠ” ìœ„í—˜/ê°•ì¡° ìƒ‰ìƒ */
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 700;
    font-size: 1rem;
    transition: background-color 0.2s ease;
    white-space: nowrap; /* ë²„íŠ¼ ê¸€ìê°€ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
}

.betting-btn:hover {
    background-color: #c9302c; /* í˜¸ë²„ ì‹œ ë” ì–´ë‘ìš´ ìƒ‰ìƒ */
}


    </style>
</head>
<body>
  <div id="app" class="container">
    <header class="header">
      <div style="display: flex; align-items: center; gap: 1rem;">
    <h1 id="logo">ì˜¬ ì¸ äºº</h1>
    <a href="test.html" class="betting-btn">ë°°íŒ…í•˜ê¸°</a>
</div>
      <div id="mobile-user-menu" class="mobile-user-menu"></div>
      <div class="main-nav-container">
          <nav class="main-nav">
            <ul>
              <li><a href="#" class="nav-link" data-board="announcements">ê³µì§€ì‚¬í•­</a></li>
              <li><a href="#" class="nav-link" data-board="freeboard">ììœ ê²Œì‹œíŒ</a></li>
              <li class="sports-gallery-menu" id="sports-gallery-menu">
                <a href="#" id="sports-gallery-toggle" class="nav-link sports-gallery-toggle" data-board-group="sports">ìŠ¤í¬ì¸  ê°¤ëŸ¬ë¦¬ â–¾</a>
                <div id="sports-gallery-dropdown" class="sports-gallery-dropdown">
                  <a href="#" class="nav-link" data-board="soccer">ì¶•êµ¬</a>
                  <a href="#" class="nav-link" data-board="baseball">ì•¼êµ¬</a>
                  <a href="#" class="nav-link" data-board="basketball">ë†êµ¬</a>
                  <a href="#" class="nav-link" data-board="esports">eìŠ¤í¬ì¸ </a>
                </div>
              </li>
            </ul>
          </nav>
      </div>
    </header>

    <main>
      <div id="main-view" class="view active">
<div class="main-banner">
    <div class="banner-content">
        <div class="banner-slides-container">
            <div class="banner-slide">
                 <h2>ë°°ë„ˆ ë¡œë”© ì¤‘...</h2>
                 <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>
        </div>
    </div>
    <button id="prev-banner-btn" class="banner-nav-btn">â€¹</button>
    <button id="next-banner-btn" class="banner-nav-btn">â€º</button>
</div>
          <div class="main-grid">
            <div class="main-left">
                <!-- Left widgets are rendered here by JS -->
            </div>
            <div class="main-right">
                <!-- Right widgets are rendered here by JS -->
            </div>
          </div>
      </div>

      <div id="board-view" class="view">
        <div class="board-header">
          <h2 id="board-title"></h2>
          <button id="write-post-btn" class="write-btn primary">ê¸€ì“°ê¸°</button>
        </div>
        <div id="post-list-container" class="table-container"></div>
        <div id="pagination" class="pagination"></div>
      </div>

      <div id="post-view" class="view"></div>
      <div id="write-view" class="view"></div>
      <div id="search-results-view" class="view"></div>
    </main>
  </div>

  <div id="login-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header"><h2>ë¡œê·¸ì¸</h2><button class="modal-close-btn">&times;</button></div>
        <div class="modal-body">
          <form id="login-form">
            <div class="form-group"><label for="login-email">ì´ë©”ì¼</label><input type="email" id="login-email" required /></div>
            <div class="form-group"><label for="login-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="login-password" required /></div>
            <button type="submit" class="write-btn primary" style="width:100%; padding: 8px;">ë¡œê·¸ì¸</button>
          </form>
        </div>
      </div>
  </div>
  <div id="signup-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header"><h2>íšŒì›ê°€ì…</h2><button class="modal-close-btn">&times;</button></div>
        <div class="modal-body">
          <form id="signup-form">
            <div class="form-group"><label for="signup-nickname">ë‹‰ë„¤ì„</label><input type="text" id="signup-nickname" required /></div>
            <div class="form-group"><label for="signup-email">ì´ë©”ì¼</label><input type="email" id="signup-email" required /></div>
            <div class="form-group"><label for="signup-password">ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="signup-password" minlength="6" required /></div>
            <button type="submit" class="write-btn primary" style="width:100%; padding: 8px;">ê°€ì…í•˜ê¸°</button>
          </form>
        </div>
      </div>
  </div>

  <footer style="background-color: #e2e2e2; color: #555; margin-top: auto; padding: 1.5rem 0; text-align:center; border-top: 1px solid #dcdcdc;">
      <p style="font-weight:700; margin:0 0 5px 0;">ì˜¬ ì¸ äºº</p>
      <div style="margin-bottom: 5px;">
        <a href="#" style="color:#555; text-decoration:none; margin: 0 5px;">íšŒì‚¬ì†Œê°œ</a>
        <a href="#" style="color:#555; text-decoration:none; margin: 0 5px;">ì´ìš©ì•½ê´€</a>
      </div>
      <p style="font-size: 0.8em; color: #888; margin:0;">Â© 2025 All In äºº. All Rights Reserved.</p>
  </footer>

<script type="module">
  // Firebase SDK IMPORTS
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, orderBy, limit, addDoc, serverTimestamp, increment, updateDoc, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // FIREBASE CONFIG
  const firebaseConfig = {
  apiKey: "AIzaSyAUuUlYHUwOuwnm_hsIsd7XHlj5voCecQk",
  authDomain: "community-d18d4.firebaseapp.com",
  projectId: "community-d18d4",
  storageBucket: "community-d18d4.firebasestorage.app", // <--- ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•˜ì„¸ìš”!
  messagingSenderId: "497702481194",
  appId: "1:497702481194:web:a826db91628adc24718253"
};

  // FIREBASE INITIALIZATION
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // APP STATE
  const appState = { currentUser: null, currentView: 'main-view', currentBoard: null, currentPostId: null, currentPage: 1, postsPerPage: 15 };
  const boardNames = { freeboard: 'ììœ ê²Œì‹œíŒ', announcements: 'ê³µì§€ì‚¬í•­', soccer: 'ì¶•êµ¬', baseball: 'ì•¼êµ¬', basketball: 'ë†êµ¬', esports: 'eìŠ¤í¬ì¸ ' };

  // UTILITY & VIEW FUNCTIONS
  function showView(viewId) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(viewId)?.classList.add('active');
    appState.currentView = viewId;
    window.scrollTo(0, 0);
  }

  function wirePostLinks(root = document) {
    root.querySelectorAll('.post-link').forEach(el => {
      if (el.__wired) return;
      el.__wired = true;
      el.addEventListener('click', (e) => {
        e.preventDefault();
        const postId = el.dataset.postId;
        const boardId = el.dataset.board;
        if (postId && boardId) renderPostView(boardId, postId);
      });
    });
  }

  // RENDER FUNCTIONS (RESTRUCTURED)


// renderMainView í•¨ìˆ˜ë¥¼ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•˜ì„¸ìš”.

// index.html íŒŒì¼ì˜ ê¸°ì¡´ renderMainView í•¨ìˆ˜ ì „ì²´ë¥¼ ì•„ë˜ ì½”ë“œë¡œ êµì²´

async function renderMainView() {
    showView('main-view');
    
    // --- ë°°ë„ˆ ë¡œì§ (ìˆ˜ì • ì—†ìŒ) ---
    const slidesContainer = document.querySelector('.banner-slides-container');
    const prevBtn = document.getElementById('prev-banner-btn');
    const nextBtn = document.getElementById('next-banner-btn');
    let bannerItems = [];
    let currentIndex = 0;

    function showBanner(index) {
        slidesContainer.style.transform = `translateX(-${index * 100}%)`;
    }

    nextBtn.addEventListener('click', () => {
        if (bannerItems.length === 0) return;
        currentIndex = (currentIndex + 1) % bannerItems.length;
        showBanner(currentIndex);
    });

    prevBtn.addEventListener('click', () => {
        if (bannerItems.length === 0) return;
        currentIndex = (currentIndex - 1 + bannerItems.length) % bannerItems.length;
        showBanner(currentIndex);
    });

    try {
        const bannerRef = doc(db, "site_config", "main_banner");
        const bannerSnap = await getDoc(bannerRef);
        
        if (bannerSnap.exists() && bannerSnap.data().items && bannerSnap.data().items.length > 0) {
            bannerItems = bannerSnap.data().items;
            slidesContainer.innerHTML = ''; 
            bannerItems.forEach(item => {
                const slide = document.createElement('div');
                slide.className = 'banner-slide';
                if (item.imageUrl) {
                    slide.style.backgroundImage = `url('${item.imageUrl}')`;
                }
                slide.innerHTML = `
                    <div class="banner-text-overlay">
                        <h2>${item.title}</h2>
                        <p>${item.description}</p>
                    </div>`;
                slidesContainer.appendChild(slide);
            });
            const showButtons = bannerItems.length > 1;
            prevBtn.style.display = showButtons ? 'block' : 'none';
            nextBtn.style.display = showButtons ? 'block' : 'none';
            showBanner(0);
        } else {
            slidesContainer.innerHTML = `
                <div class="banner-slide" style="background-color: #5f4b8b;">
                    <div class="banner-text-overlay">
                        <h2>ì˜¬ ì¸ äººì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
                        <p>ììœ ë¡­ê²Œ ì†Œí†µí•˜ê³  ì¦ê²¨ë³´ì„¸ìš”!</p>
                    </div>
                </div>`;
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }
    } catch (error) {
        console.error("ë°°ë„ˆ ë¡œë”© ì‹¤íŒ¨:", error);
        slidesContainer.innerHTML = `<div class="banner-slide"><h2>ë°°ë„ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</h2></div>`;
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    }

    // --- â–¼â–¼â–¼ ìœ„ì ¯ ë Œë”ë§ ë¡œì§ (if ì¡°ê±´ë¬¸ ì œê±°) â–¼â–¼â–¼ ---
    const leftCol = document.querySelector('#main-view .main-left');
    const rightCol = document.querySelector('#main-view .main-right');
    
    // âœ… ë¬¸ì œê°€ ë˜ì—ˆë˜ if (!leftCol.innerHTML.trim()) { ... } ì¡°ê±´ë¬¸ì„ ì œê±°í•˜ì—¬
    // í•­ìƒ ìœ„ì ¯ì´ ê·¸ë ¤ì§€ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
    leftCol.innerHTML = `
        <div id="announcements-widget" class="widget"></div>
        <div id="popular-posts-widget" class="widget"></div>
        <div class="prediction-widget-container widget"></div> 
        <div class="widget-grid">
            <div id="freeboard-widget" class="widget"></div>
            <div id="soccer-widget" class="widget"></div>
            <div id="baseball-widget" class="widget"></div>
            <div id="esports-widget" class="widget"></div>
        </div>`;
    rightCol.innerHTML = `
        <div id="sidebar-login-widget" class="widget"></div>
        <div class="prediction-widget-container widget"></div>
        <div id="sidebar-ranking-widget" class="widget">
            <div class="widget-header"><h2>ì‹¤ì‹œê°„ ê°¤ëŸ¬ë¦¬ ìˆœìœ„</h2></div>
            <div class="widget-body"><p style="text-align:center; color: var(--text-light);">ìˆœìœ„ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p></div>
        </div>`;
    
    renderBoardPreview('announcements-widget', 'announcements', 'ê³µì§€ì‚¬í•­', 5);
    renderBoardPreview('popular-posts-widget', 'popular', 'ì»¤ë®¤ë‹ˆí‹° ì¸ê¸°ê¸€', 5);
    renderBoardPreview('freeboard-widget', 'freeboard', 'ììœ ê²Œì‹œíŒ', 5);
    renderBoardPreview('soccer-widget', 'soccer', 'ì¶•êµ¬', 5);
    renderBoardPreview('baseball-widget', 'baseball', 'ì•¼êµ¬', 5);
    renderBoardPreview('esports-widget', 'esports', 'eìŠ¤í¬ì¸ ', 5);
    renderSidebar();
}

  async function renderBoardPreview(containerId, boardId, title, count) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const boardLink = boardId === 'popular' ? 'freeboard' : boardId;
      container.innerHTML = `
          <div class="widget-header">
              <h2>${title}</h2>
              <a href="#" class="view-more nav-link" data-board="${boardLink}">ë”ë³´ê¸°+</a>
          </div>
          <div class="widget-body"><ul class="preview-list" id="list-${containerId}"><li>ë¡œë”© ì¤‘...</li></ul></div>
      `;

      const qy = boardId === 'popular'
          ? query(collection(db, 'posts'), orderBy('likes', 'desc'), limit(count))
          : query(collection(db, 'posts'), where("board", "==", boardId), orderBy("createdAt", "desc"), limit(count));
      
      try {
        const snapshot = await getDocs(qy);
        const posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        const listEl = document.getElementById(`list-${containerId}`);
        const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' }) : '';
        
        if (posts.length) {
            listEl.innerHTML = posts.map(post => `
                <li class="preview-list-item">
                    <a href="#" class="preview-title post-link" data-post-id="${post.id}" data-board="${post.board}">${post.title}</a>
                    ${post.commentCount > 0 ? `<span class="comment-count">[${post.commentCount}]</span>` : ''}
                    <span class="preview-date">${formatDate(post.createdAt)}</span>
                </li>
            `).join('');
        } else {
            listEl.innerHTML = '<li style="text-align:center; color: var(--text-light); padding: 1rem 0;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        }
        wirePostLinks(listEl);
      } catch (err) {
          console.error(`Error loading ${title}:`, err);
          document.getElementById(`list-${containerId}`).innerHTML = '<li>ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</li>';
      }
  }

  function renderSidebar() {
      // Login Widget
      const loginContainer = document.getElementById('sidebar-login-widget');
      if (!loginContainer) return;
      const user = appState.currentUser;
      if (user) {
          loginContainer.innerHTML = `
              <div class="widget-body" style="text-align:center; padding: 1.5rem 1rem;">
                  <p style="font-weight:700; font-size: 1.1em; margin:0 0 1rem 0;">${user.nickname}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</p>
                  <button id="sidebar-logout-btn" class="write-btn">ë¡œê·¸ì•„ì›ƒ</button>
              </div>
          `;
          document.getElementById('sidebar-logout-btn').addEventListener('click', () => signOut(auth));
      } else {
          loginContainer.innerHTML = `
              <div class="widget-header"><h2>ë¡œê·¸ì¸</h2></div>
              <div class="widget-body">
                  <form id="sidebar-login-form">
                      <input type="email" id="sidebar-login-email" placeholder="ì´ë©”ì¼" required class="sidebar-input">
                      <input type="password" id="sidebar-login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required class="sidebar-input">
                      <button type="submit" class="write-btn primary" style="width:100%;">ë¡œê·¸ì¸</button>
                      <div class="sidebar-auth-links">
                          <a href="#" id="sidebar-signup-link">íšŒì›ê°€ì…</a>
                          <a href="#">ì •ë³´ì°¾ê¸°</a>
                      </div>
                  </form>
              </div>
          `;
          document.getElementById('sidebar-login-form').addEventListener('submit', async (e) => {
               e.preventDefault();
               const email = document.getElementById('sidebar-login-email').value;
               const password = document.getElementById('sidebar-login-password').value;
               try { await signInWithEmailAndPassword(auth, email, password); } 
               catch (error) { alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`); }
          });
          document.getElementById('sidebar-signup-link').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-modal').classList.add('show'); });
      }

      // AI Prediction Widget
    const predictionContainers = document.querySelectorAll('.prediction-widget-container');

    if (predictionContainers.length > 0) {
        // ê° ì»¨í…Œì´ë„ˆ(ë°ìŠ¤í¬í†±ìš©, ëª¨ë°”ì¼ìš©)ì— ëŒ€í•´ ë™ì¼í•œ ë‚´ìš©ì„ ì±„ì›Œì¤ë‹ˆë‹¤.
        predictionContainers.forEach(predictionContainer => {
            predictionContainer.innerHTML = `
                <div class="widget-header"><h2>AI ìŠ¹ë¶€ ì˜ˆì¸¡</h2></div>
                <div class="widget-body">
                    <div style="display:flex; gap:.75rem; margin-bottom:.75rem; align-items:center; flex-wrap:wrap;">
                        <select class="ai-sport-select" style="padding:4px; border:1px solid var(--border-color);">
                            <option value="ì¶•êµ¬">ì¶•êµ¬</option> <option value="ì•¼êµ¬">ì•¼êµ¬</option> <option value="ë†êµ¬">ë†êµ¬</option>
                        </select>
                        <input type="text" class="ai-team-a" placeholder="íŒ€ A" style="flex:1; padding:6px; border:1px solid var(--border-color);">
                        <span style="font-weight:700;">VS</span>
                        <input type="text" class="ai-team-b" placeholder="íŒ€ B" style="flex:1; padding:6px; border:1px solid var(--border-color);">
                    </div>
                    <button class="ai-predict-btn write-btn primary" style="width:100%">ì˜ˆì¸¡í•˜ê¸°</button>
                    <div class="ai-prediction-result" style="margin-top:1rem; padding:.75rem; border:1px dashed var(--border-color); min-height:50px; white-space:pre-wrap; line-height:1.6; text-align:center;">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            `;
            
            // ê° ìœ„ì ¯ì˜ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.
            predictionContainer.querySelector('.ai-predict-btn').addEventListener('click', async () => {
                // id ëŒ€ì‹  classë¡œ ìš”ì†Œë¥¼ ì°¾ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
                const resultDiv = predictionContainer.querySelector('.ai-prediction-result');
                const predictBtn = predictionContainer.querySelector('.ai-predict-btn');
                const sport = predictionContainer.querySelector('.ai-sport-select').value;
                const teamA = predictionContainer.querySelector('.ai-team-a').value.trim();
                const teamB = predictionContainer.querySelector('.ai-team-b').value.trim();
                

    // 2. ì…ë ¥ ê°’ ìœ íš¨ì„± ê²€ì‚¬
    if (!teamA || !teamB) {
        resultDiv.textContent = 'íŒ€ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
    }

    resultDiv.textContent = 'AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–';

    // 3. ì„œë²„ API í˜¸ì¶œ (fetch ì‚¬ìš©)
    try {
        const response = await fetch('/api/predict', { // ì„œë²„ì— ë°°í¬ëœ API ê²½ë¡œ
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sport, teamA, teamB }), // ì…ë ¥ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì „ì†¡
        });

        if (!response.ok) {
            // ì„œë²„ì—ì„œ ì—ëŸ¬ ì‘ë‹µì„ ë³´ëƒˆì„ ê²½ìš°
            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.statusText}`);
        }

        const data = await response.json(); // ì„œë²„ë¡œë¶€í„° ë°›ì€ JSON ê²°ê³¼ íŒŒì‹±

        // 4. ê²°ê³¼ í‘œì‹œ
        resultDiv.textContent = data.prediction; // APIê°€ ëŒë ¤ì¤€ ì˜ˆì¸¡ ê²°ê³¼ ë©”ì‹œì§€

    } catch (error) {
        // 5. ì—ëŸ¬ ì²˜ë¦¬
        console.error('AI ì˜ˆì¸¡ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        resultDiv.textContent = 'ì˜ˆì¸¡ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
            });
        });
    }
}
  
  async function safeUpdateViewCount(postRef) {
    try {
      const snap = await getDoc(postRef);
      if (snap.exists()) { await updateDoc(postRef, { views: increment(1) }); }
    } catch (err) { console.warn('ViewCount update skipped:', err.message); }
  }

  async function fetchPostsForBoard(boardId, page = 1) {
    const qy = query(collection(db, 'posts'), where("board", "==", boardId), orderBy("createdAt", "desc"), limit(appState.postsPerPage));
    const snapshot = await getDocs(qy);
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  
  async function fetchSearchResults(queryText) {
    const qy = query(collection(db, "posts"), where("title", ">=", queryText), where("title", "<=", queryText + '\uf8ff'), orderBy("title"), limit(20));
    const snapshot = await getDocs(qy);
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function renderBoardView(boardId, page) {
    appState.currentBoard = boardId;
    appState.currentPage = page;
    showView('board-view');
    document.getElementById('board-title').textContent = boardNames[boardId];

    const container = document.getElementById('post-list-container');
    const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleDateString('ko-KR') : '-';
    const posts = await fetchPostsForBoard(boardId, page);

    if (!posts.length) {
      container.innerHTML = '<div style="text-align:center; padding: 3rem 0; background: var(--background-white);">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    container.innerHTML = `
      <table class="post-table">
        <thead>
          <tr>
            <th>ë²ˆí˜¸</th><th>ì œëª©</th><th>ê¸€ì“´ì´</th><th>ì‘ì„±ì¼</th><th>ì¡°íšŒ</th><th>ì¶”ì²œ</th>
          </tr>
        </thead>
        <tbody>
          ${posts.map((post) => `
            <tr class="post-link" data-post-id="${post.id}" data-board="${post.board}">
              <td data-label="ë²ˆí˜¸">${post.id.substring(0, 6)}</td>
              <td data-label="ì œëª©">
                <a href="#" class="post-title-link">${post.title}</a>
                ${post.commentCount > 0 ? `<span class="comment-count" style="margin-left:4px">[${post.commentCount}]</span>` : ''}
              </td>
              <td data-label="ê¸€ì“´ì´">${post.authorName}</td>
              <td data-label="ì‘ì„±ì¼">${formatDate(post.createdAt)}</td>
              <td data-label="ì¡°íšŒ">${post.views || 0}</td>
              <td data-label="ì¶”ì²œ">${post.likes || 0}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
    wirePostLinks(container);
    document.getElementById('write-post-btn')?.addEventListener('click', renderWriteView);
  }

async function renderPostView(boardId, postId) {
  showView('post-view');
  appState.currentBoard = boardId;
  appState.currentPostId = postId;

  const postRef = doc(db, "posts", postId);
  await safeUpdateViewCount(postRef);
  const postSnap = await getDoc(postRef);

  if (!postSnap.exists()) {
    alert("ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return renderBoardView(boardId, 1);
  }

  const post = postSnap.data();
  const container = document.getElementById('post-view');
  const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('ko-KR') : '';
  const isAuthor = appState.currentUser && appState.currentUser.uid === post.authorId;
  const authorButtons = `<button id="edit-post-btn" class="write-btn">ìˆ˜ì •</button> <button id="delete-post-btn" class="write-btn">ì‚­ì œ</button>`;

  // ê°¤ëŸ¬ë¦¬ HTML ë¨¼ì € ë¬¸ìì—´ë¡œ ì¤€ë¹„
  const imgList = Array.isArray(post.imageUrls) ? post.imageUrls : (post.imageUrl ? [post.imageUrl] : []);
  const imageHtml = imgList.length ? `
    <div class="post-gallery" style="margin:1rem 0;">
      <div class="post-gallery-main" style="position:relative;">
        <img id="post-gallery-main-img" src="${imgList[0]}" alt="${post.title}" 
             style="width:100%; max-height:520px; object-fit:contain; background:#f7f7fa; border:1px solid var(--border-color); border-radius:6px;">
        ${imgList.length > 1 ? `
        <button id="pg-prev" class="banner-nav-btn" style="left:8px;">â€¹</button>
        <button id="pg-next" class="banner-nav-btn" style="right:8px;">â€º</button>` : ``}
      </div>
      ${imgList.length > 1 ? `
      <div class="post-gallery-thumbs" style="display:flex; gap:.5rem; margin-top:.5rem; overflow-x:auto; padding-bottom:.25rem;">
        ${imgList.map((u,i)=>`
          <img data-idx="${i}" src="${u}" style="width:80px;height:80px;object-fit:cover;border:1px solid var(--border-color);border-radius:6px;cursor:pointer;">
        `).join('')}
      </div>` : ``}
    </div>
  ` : '';

  // 1) DOM ê·¸ë¦¬ê¸°
  container.innerHTML = `
    <div id="post-content-view">
      <div class="post-header">
        <h1>${post.title}</h1>
        <div id="post-meta"><b>ê¸€ì“´ì´:</b> ${post.authorName} | <b>ì‘ì„±ì¼:</b> ${formatDate(post.createdAt)} | <b>ì¡°íšŒ:</b> ${post.views || 0}</div>
      </div>
      <div id="post-body" style="padding: 1.5rem; font-size: 1.05em; line-height: 1.8; min-height: 200px;">
        ${imageHtml}
        ${(post.content || '').replace(/\n/g, '<br>')}
      </div>
      <div id="vote-bar" style="padding: 1rem; display:flex; justify-content: center; gap: 0.5rem; align-items:center; border-top: 1px solid var(--border-color);">
        <button id="like-btn" class="write-btn">ğŸ‘ ì¶”ì²œ <span id="like-count">${post.likes || 0}</span></button>
        <button id="dislike-btn" class="write-btn">ğŸ‘ ë¹„ì¶”ì²œ <span id="dislike-count">${post.dislikes || 0}</span></button>
      </div>
      <div class="post-actions" style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; background-color: var(--background-widget-header);">
        <button id="back-to-list-btn" class="write-btn">ëª©ë¡</button>
        <div class="author-actions">${isAuthor ? authorButtons : ''}</div>
      </div>
    </div>
    <div id="comments-section">
      <h3>ëŒ“ê¸€</h3>
      <ul id="comments-list"></ul>
      ${appState.currentUser ? `
      <form id="comment-form" class="comment-form" style="padding:1rem; border-top:1px solid var(--border-color); display:flex; gap:0.5rem;">
        <textarea id="comment-text" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required style="flex-grow: 1; border: 1px solid var(--border-color); padding: 5px; resize: vertical; min-height: 50px;"></textarea>
        <button type="submit" class="write-btn primary">ë“±ë¡</button>
      </form>
      ` : `<p style="text-align:center; padding: 1rem; background-color: var(--background-widget-header);">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>`}
    </div>`;

  // 2) DOMì´ ìƒì„±ëœ í›„ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
  if (imgList.length > 0) {
    const mainImg = document.getElementById('post-gallery-main-img');
    let cur = 0;
    const show = (i) => { cur = (i + imgList.length) % imgList.length; mainImg.src = imgList[cur]; };
    document.getElementById('pg-prev')?.addEventListener('click', ()=> show(cur-1));
    document.getElementById('pg-next')?.addEventListener('click', ()=> show(cur+1));
    document.querySelectorAll('.post-gallery-thumbs img').forEach(el=>{
      el.addEventListener('click', ()=> show(parseInt(el.dataset.idx,10)));
    });
  }

  setupVoteUI(postId);
  renderComments(postId);

  document.getElementById('back-to-list-btn').addEventListener('click', () => renderBoardView(boardId, 1));
  if (appState.currentUser) document.getElementById('comment-form')?.addEventListener('submit', (e) => handleCommentSubmit(e, postId));
  if (isAuthor) {
    document.getElementById('edit-post-btn')?.addEventListener('click', () => renderEditView(postId));
    document.getElementById('delete-post-btn')?.addEventListener('click', () => handlePostDelete(postId, boardId));
  }
}

  async function renderEditView(postId) {
    const postRef = doc(db, "posts", postId);
    const postSnap = await getDoc(postRef);
    if (!postSnap.exists()) {
      alert("ìˆ˜ì •í•  ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return renderBoardView(appState.currentBoard, 1);
    }
    const post = postSnap.data();

    showView('write-view');
    const container = document.getElementById('write-view');
    container.innerHTML = `
      <div id="write-form-container" style="border:1px solid var(--border-color); background:var(--background-white);">
        <h2 style="padding:0.75rem 1rem; margin:0; border-bottom:1px solid var(--border-color); background:var(--background-widget-header);">ê²Œì‹œë¬¼ ìˆ˜ì •</h2>
        <form id="edit-form" data-post-id="${postId}" style="padding:1rem;">
          <input type="text" id="edit-title" value="${post.title}" required style="width:100%; padding:8px; border:1px solid var(--border-color); margin-bottom:0.5rem;">
          <textarea id="edit-content" required style="width:100%; min-height:300px; padding:8px; border:1px solid var(--border-color); margin-bottom:1rem;">${post.content}</textarea>
          <div style="text-align:right; display:flex; justify-content:flex-end; gap:0.5rem;">
            <button type="button" id="cancel-edit-btn" class="write-btn">ì·¨ì†Œ</button>
            <button type="submit" class="write-btn primary">ìˆ˜ì •í•˜ê¸°</button>
          </div>
        </form>
      </div>`;

    document.getElementById('edit-form').addEventListener('submit', handlePostUpdate);
    document.getElementById('cancel-edit-btn').addEventListener('click', () => renderPostView(post.board, postId));
  }

  function renderWriteView() {
    showView('write-view');
    const container = document.getElementById('write-view');
    container.innerHTML = `
      <div id="write-form-container" style="border:1px solid var(--border-color); background:var(--background-white);">
        <h2 style="padding:0.75rem 1rem; margin:0; border-bottom:1px solid var(--border-color); background:var(--background-widget-header);">${boardNames[appState.currentBoard]} ê¸€ì“°ê¸°</h2>
        <form id="write-form" style="padding:1rem;">
          <input type="text" id="write-title" placeholder="ì œëª©" required style="width:100%; padding:8px; border:1px solid var(--border-color); margin-bottom:0.5rem;">
          <div style="margin-bottom: 0.75rem;">
  <label for="write-images" style="font-weight: 500; display: block; margin-bottom: .25rem;">
    ì´ë¯¸ì§€ (ì„ íƒ, ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)
  </label>
  <input type="file" id="write-images" accept="image/*" multiple>
  <div id="write-image-preview" style="display:flex; gap:.5rem; margin-top:.5rem; flex-wrap:wrap;"></div>
  <small style="color:#888;">TIP: Ctrl/Shiftë¡œ ì—¬ëŸ¬ ì¥ ì„ íƒ. (ê¶Œì¥ 10ì¥ ì´í•˜)</small>
</div>
          <textarea id="write-content" placeholder="ë‚´ìš©" required style="width:100%; min-height:300px; padding:8px; border:1px solid var(--border-color); margin-bottom:1rem;"></textarea>
          <div style="text-align:right; display:flex; justify-content:flex-end; gap:0.5rem;">
            <button type="button" id="cancel-write-btn" class="write-btn">ì·¨ì†Œ</button>
            <button type="submit" id="submit-post-btn" class="write-btn primary">ë“±ë¡</button>
          </div>
        </form>
      </div>`;

    // âœ… ì—¬ê¸°ì„œ ë°”ì¸ë”©
  const imgInput = document.getElementById('write-images');
  const preview = document.getElementById('write-image-preview');
  imgInput.addEventListener('change', () => {
    preview.innerHTML = '';
    const files = Array.from(imgInput.files || []);
    files.forEach(file => {
      const url = URL.createObjectURL(file);
      const thumb = document.createElement('img');
      thumb.src = url;
      thumb.style = "width:90px;height:90px;object-fit:cover;border:1px solid var(--border-color);border-radius:6px;";
      preview.appendChild(thumb);
    });
  });

  document.getElementById('write-form').addEventListener('submit', handlePostSubmit);
  document.getElementById('cancel-write-btn').addEventListener('click', () => renderBoardView(appState.currentBoard, 1));
  }


async function uploadImagesAndGetUrls(files) {
  const urls = [];
  for (const f of files) {
    const path = `images/${Date.now()}-${Math.random().toString(36).slice(2)}-${f.name}`;
    const storageRefObj = ref(storage, path);
    const result = await uploadBytes(storageRefObj, f);
    const dl = await getDownloadURL(result.ref);
    urls.push(dl);
  }
  return urls;
}

async function handleVote(postId, value) {
  const user = appState.currentUser;
  if (!user) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }

  const postRef = doc(db, "posts", postId);
  const voteRef = doc(db, "posts", postId, "votes", user.uid);

  try {
    await runTransaction(db, async (tx) => {
      const [postSnap, voteSnap] = await Promise.all([tx.get(postRef), tx.get(voteRef)]);
      if (!postSnap.exists()) throw new Error("Post not found");

      let { likes = 0, dislikes = 0 } = postSnap.data();

      if (!voteSnap.exists()) {
        if (value === 1) likes++; else dislikes++;
        tx.set(voteRef, { value });
      } else {
        const prev = voteSnap.data().value;
        if (prev === value) {
          if (value === 1) likes--; else dislikes--;
          tx.delete(voteRef);
        } else {
          if (value === 1) { likes++; dislikes--; } else { dislikes++; likes--; }
          tx.update(voteRef, { value });
        }
      }
      tx.update(postRef, { likes, dislikes });
    });

    // ì¹´ìš´íŠ¸ UIë§Œ ìµœì‹ í™”
    const latest = (await getDoc(postRef)).data();
    document.getElementById('like-count').textContent = latest.likes || 0;
    document.getElementById('dislike-count').textContent = latest.dislikes || 0;
  } catch (e) {
    console.error(e);
    alert("íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

   async function renderComments(postId) {
    const commentsList = document.getElementById('comments-list');
    if (!commentsList) return;
    commentsList.innerHTML = '<li>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
    const commentsCol = collection(db, "posts", postId, "comments");
    const qy = query(commentsCol, orderBy("createdAt"));
    const snapshot = await getDocs(qy);
    const commentsMap = new Map();
    snapshot.docs.forEach(d => { commentsMap.set(d.id, { id: d.id, children: [], ...d.data() }); });
    const roots = [];
    commentsMap.forEach(c => {
      if (c.parentId && commentsMap.has(c.parentId)) commentsMap.get(c.parentId).children.push(c);
      else roots.push(c);
    });
    commentsList.innerHTML = '';
    if (!roots.length) {
      commentsList.innerHTML = '<li style="text-align:center; padding: 1.5rem 0; color:var(--text-light)">ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      return;
    }
    roots.forEach(c => commentsList.appendChild(createCommentElement(c)));
  }

  function createCommentElement(comment) {
    const li = document.createElement('li');
    li.className = 'comment-item'; li.id = `comment-${comment.id}`;
    li.style = "padding: 0.75rem; border-bottom: 1px dotted var(--border-color);"
    const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('ko-KR') : '';
    li.innerHTML = `
      <div><span style="font-weight: 700; color: var(--primary-dark);">${comment.authorName}</span> <span style="font-size: 0.9em; color: #999; margin-left: 0.5rem;">${formatDate(comment.createdAt)}</span></div>
      <p style="margin: 0.5rem 0;">${(comment.text || '').replace(/\n/g, '<br>')}</p>
      ${appState.currentUser ? `<button class="reply-btn" data-comment-id="${comment.id}" style="background:none; border:none; color:var(--text-light); cursor:pointer; font-size:0.9em; padding:0;">ë‹µê¸€</button>` : ''}`;
    if (comment.children.length > 0) {
      const replyList = document.createElement('ul');
      replyList.style = "margin-top: 0.75rem; padding-left: 1rem; border-left: 3px solid #f0f2f5;";
      comment.children.forEach(r => replyList.appendChild(createCommentElement(r)));
      li.appendChild(replyList);
    }
    li.querySelector('.reply-btn')?.addEventListener('click', showReplyForm);
    return li;
  }
   function showReplyForm(e) {
    const parentCommentId = e.target.dataset.commentId;
    const parentCommentItem = document.getElementById(`comment-${parentCommentId}`);
    const existing = parentCommentItem.querySelector('.reply-form-container');
    if (existing) { existing.remove(); return; }
    const formContainer = document.createElement('div');
    formContainer.className = 'reply-form-container';
    formContainer.innerHTML = `<form class="comment-form reply-form" style="padding:0.5rem; margin-top:0.5rem; display:flex; gap:0.5rem;"><textarea placeholder="ë‹µê¸€..." required style="flex-grow:1; min-height:40px; border:1px solid var(--border-color);"></textarea><button type="submit" class="write-btn">ë“±ë¡</button></form>`;
    formContainer.querySelector('.reply-form').addEventListener('submit', (event) => handleCommentSubmit(event, appState.currentPostId, parentCommentId));
    parentCommentItem.appendChild(formContainer);
    formContainer.querySelector('textarea').focus();
  }

  async function setupVoteUI(postId) {
  const likeBtn = document.getElementById('like-btn');
  const dislikeBtn = document.getElementById('dislike-btn');
  if (!likeBtn || !dislikeBtn) return;

  if (!likeBtn.__wired) {
    likeBtn.__wired = true;
    dislikeBtn.__wired = true;
    likeBtn.addEventListener('click', () => handleVote(postId, 1));
    dislikeBtn.addEventListener('click', () => handleVote(postId, -1));
  }

  const user = appState.currentUser; 
  if (!user) return;
  const voteRef = doc(db, "posts", postId, "votes", user.uid);
  const snap = await getDoc(voteRef);
  if (snap.exists()) {
    const v = snap.data().value;
    if (v === 1) { likeBtn.style.backgroundColor = 'var(--primary-light)'; likeBtn.style.borderColor = 'var(--primary-dark)';}
    if (v === -1) { dislikeBtn.style.backgroundColor = 'var(--primary-light)'; dislikeBtn.style.borderColor = 'var(--primary-dark)';}
  }
}
  async function handlePostSubmit(e) {
  e.preventDefault();
  const title = document.getElementById('write-title').value;
  const content = document.getElementById('write-content').value;
  const user = appState.currentUser; 
  if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

  const submitBtn = document.getElementById('submit-post-btn');
  submitBtn.disabled = true; 
  submitBtn.textContent = 'ë“±ë¡ ì¤‘...';

  try {
    // ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ
    const files = Array.from(document.getElementById('write-images')?.files || []);
    let imageUrls = [];
    if (files.length) {
      submitBtn.textContent = `ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘... (${files.length}ì¥)`;
      imageUrls = await uploadImagesAndGetUrls(files);
    }

    const postData = {
      title,
      content,
      // í˜¸í™˜ì„±: ì˜ˆì „ ì½”ë“œê°€ ì“°ëŠ” ë‹¨ì¼ í•„ë“œë„ í•¨ê»˜ ê¸°ë¡
      imageUrl: imageUrls[0] || null,
      imageUrls,
      authorId: user.uid,
      authorName: user.nickname,
      board: appState.currentBoard,
      createdAt: serverTimestamp(),
      views: 0, likes: 0, dislikes: 0, commentCount: 0
    };

    await addDoc(collection(db, 'posts'), postData);
    alert("ê²Œì‹œë¬¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    renderBoardView(appState.currentBoard, 1);
  } catch (error) {
    console.error("ê²Œì‹œë¬¼ ë“±ë¡ ì˜¤ë¥˜: ", error);
    alert("ê²Œì‹œë¬¼ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    submitBtn.disabled = false; 
    submitBtn.textContent = 'ë“±ë¡';
  }
}
  async function handlePostUpdate(e) {
    e.preventDefault();
    const postId = e.target.dataset.postId;
    const newTitle = document.getElementById('edit-title').value; const newContent = document.getElementById('edit-content').value;
    try {
      await updateDoc(doc(db, "posts", postId), { title: newTitle, content: newContent });
      alert("ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); renderPostView(appState.currentBoard, postId);
    } catch (error) { console.error("ê²Œì‹œë¬¼ ìˆ˜ì • ì˜¤ë¥˜:", error); alert("ê²Œì‹œë¬¼ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
  }
  async function handlePostDelete(postId, boardId) {
    if (confirm("ì •ë§ë¡œ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      try { await deleteDoc(doc(db, "posts", postId)); alert("ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); renderBoardView(boardId, 1); } 
      catch (error) { console.error("ê²Œì‹œë¬¼ ì‚­ì œ ì˜¤ë¥˜:", error); alert("ê²Œì‹œë¬¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
    }
  }
  async function handleCommentSubmit(e, postId, parentId = null) {
    e.preventDefault(); const user = appState.currentUser; if (!user) return;
    const textarea = e.target.querySelector('textarea'); const text = textarea.value.trim(); if (!text) return;
    try {
      const commentData = { text, authorId: user.uid, authorName: user.nickname, createdAt: serverTimestamp(), ...(parentId && { parentId }) };
      await addDoc(collection(db, "posts", postId, "comments"), commentData);
      await updateDoc(doc(db, "posts", postId), { commentCount: increment(1) });
      renderComments(postId); textarea.value = '';
      e.target.closest('.reply-form-container')?.remove();
    } catch (error) { console.error("ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜: ", error); alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
  }

// EVENT LISTENERS & INITIALIZATION
onAuthStateChanged(auth, async (user) => {
    const mobileUserMenu = document.getElementById('mobile-user-menu');
    const mainNavList = document.querySelector('.main-nav ul');
    
    // ê¸°ì¡´ ê´€ë¦¬ì ë©”ë‰´ê°€ ìˆë‹¤ë©´ ì‚­ì œ
    mainNavList.querySelector('.admin-link')?.remove();

    if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const nickname = userDoc.exists() ? userDoc.data().nickname : user.email.split('@')[0];
        appState.currentUser = { uid: user.uid, email: user.email, nickname };

        // --- ğŸ”½ [ìˆ˜ì •] ê´€ë¦¬ì í™•ì¸ ë° ë©”ë‰´ ì¶”ê°€ ---
        if (user.email === 'admin@example.com') { // ê´€ë¦¬ì ì´ë©”ì¼ ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš”.
            const adminLi = document.createElement('li');
            adminLi.className = 'admin-link';
            adminLi.innerHTML = `<a href="#" id="admin-menu-btn" class="nav-link">âš™ï¸ ê´€ë¦¬</a>`;
            mainNavList.appendChild(adminLi);
            document.getElementById('admin-menu-btn').addEventListener('click', (e) => {
                e.preventDefault();
                renderAdminView();
            });
        }
        // --- ğŸ”¼ [ìˆ˜ì •] ì—¬ê¸°ê¹Œì§€ ---
      
      if (mobileUserMenu) {
        mobileUserMenu.innerHTML = `<span>${nickname}ë‹˜</span><button id="mobile-logout-btn">ë¡œê·¸ì•„ì›ƒ</button>`;
        document.getElementById('mobile-logout-btn').addEventListener('click', () => signOut(auth));
      }
    } else {
      appState.currentUser = null;
      if (mobileUserMenu) {
        mobileUserMenu.innerHTML = `<a href="#" id="mobile-login-btn">ë¡œê·¸ì¸</a><a href="#" id="mobile-signup-btn">íšŒì›ê°€ì…</a>`;
        document.getElementById('mobile-login-btn').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-modal').classList.add('show'); });
        document.getElementById('mobile-signup-btn').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-modal').classList.add('show'); });
      }
    }

    if (appState.currentView === 'main-view') {
        renderSidebar();
    }
    if (appState.currentView === 'post-view' && appState.currentBoard && appState.currentPostId) {
        renderPostView(appState.currentBoard, appState.currentPostId);
    }
  });

  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const nickname = document.getElementById('signup-nickname').value; const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value;
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(cred.user, { displayName: nickname });
      await setDoc(doc(db, "users", cred.user.uid), { nickname, email });
      alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'); document.getElementById('signup-modal').classList.remove('show');
    } catch (error) { alert(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message}`); }
  });
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
    try { await signInWithEmailAndPassword(auth, email, password); document.getElementById('login-modal').classList.remove('show'); } 
    catch (error) { alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`); }
  });
  document.querySelectorAll('.modal-overlay').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); }); });
  document.querySelectorAll('.modal-close-btn').forEach(btn => { btn.addEventListener('click', () => { btn.closest('.modal-overlay').classList.remove('show'); }); });
  document.getElementById('sports-gallery-toggle').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('sports-gallery-dropdown').classList.toggle('show'); });
  document.addEventListener('click', (e) => {
    if (!document.getElementById('sports-gallery-menu').contains(e.target)) document.getElementById('sports-gallery-dropdown').classList.remove('show');
    const navLink = e.target.closest('.nav-link');
    if (navLink && navLink.dataset.board) {
      e.preventDefault(); renderBoardView(navLink.dataset.board, 1);
      document.getElementById('sports-gallery-dropdown').classList.remove('show');
    }
  });
  document.getElementById('write-post-btn')?.addEventListener('click', renderWriteView);
  document.getElementById('logo').addEventListener('click', renderMainView);
  
  // Initial Load
  renderMainView();
</script>
</body>
</html>